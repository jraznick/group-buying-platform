import { db, activeTierPrice } from '../store.js';
export async function settleDeal(req,res){const deal=db.deals.find(d=>d.id===req.params.id);if(!deal)return res.status(404).json({error:'Deal not found'});const pending=db.orders.filter(o=>o.deal_id===deal.id&&['authorized','reserved'].includes(o.status));const {size,price_cents}=activeTierPrice(deal.id);if(size>=deal.min_group_size){pending.forEach(o=>{o.status='captured';o.price_cents=price_cents;o.updated_at=new Date().toISOString();});deal.state='cleared';}else{pending.forEach(o=>{o.status='refunded';o.updated_at=new Date().toISOString();});deal.state='expired';}deal.updated_at=new Date().toISOString();res.json({ok:true,final_price_cents:price_cents,group_size:size,state:deal.state});}
